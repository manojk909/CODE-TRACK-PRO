{% extends "base.html" %}

{% block title %}Dashboard - CodeTrack Pro{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Welcome Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="glass-card p-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2 class="fw-bold gradient-text mb-2">
                            Welcome back, {{ user.first_name or user.username }}! ðŸ‘‹
                        </h2>
                        <p class="text-muted mb-0">Here's your coding progress overview</p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <div class="btn-group" role="group">
                            {% if not session.get('active_session_id') %}
                            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#startSessionModal">
                                <i class="fas fa-play me-2"></i>Start Study Session
                            </button>
                            {% else %}
                            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#endSessionModal">
                                <i class="fas fa-stop me-2"></i>End Session
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Overview -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="glass-card p-4 text-center">
                <div class="stat-icon mb-3">
                    <i class="fas fa-code text-primary"></i>
                </div>
                <h3 class="fw-bold mb-1">{{ total_problems }}</h3>
                <p class="text-muted mb-0">Total Problems Solved</p>
                <small class="text-success">Across all platforms</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="glass-card p-4 text-center">
                <div class="stat-icon mb-3">
                    <i class="fas fa-fire text-danger"></i>
                </div>
                <h3 class="fw-bold mb-1">
                    {% set max_streak = platform_stats|map(attribute='streak')|max %}
                    {{ max_streak or 0 }}
                </h3>
                <p class="text-muted mb-0">Max Streak</p>
                <small class="text-info">Best across platforms</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="glass-card p-4 text-center">
                <div class="stat-icon mb-3">
                    <i class="fas fa-users text-success"></i>
                </div>
                <h3 class="fw-bold mb-1">{{ user.study_group_memberships|length }}</h3>
                <p class="text-muted mb-0">Study Groups</p>
            </div>
        </div>
        <div class="col-md-3">
            <div class="glass-card p-4 text-center">
                <div class="stat-icon mb-3">
                    <i class="fas fa-trophy text-warning"></i>
                </div>
                <h3 class="fw-bold mb-1">
                    {% set contests_joined = user.contest_participations|length %}
                    {{ contests_joined or 0 }}
                </h3>
                <p class="text-muted mb-0">Contests Joined</p>
                <small class="text-info">Total competitions entered</small>
            </div>
        </div>
    </div>
    
    <!-- Daily Coding Hours Input -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="glass-card p-4">
                <h6 class="fw-bold mb-3">
                    <i class="fas fa-clock me-2"></i>Today's Coding Hours
                </h6>
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="input-group">
                            <input type="number" class="form-control" id="dailyCodingHours" 
                                   placeholder="Enter hours coded today (0-24)" 
                                   min="0" max="24" step="0.5">
                            <button class="btn btn-primary" type="button" id="submitDailyHours">
                                <i class="fas fa-save me-1"></i>Save
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <small class="text-muted">Track your daily coding time</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Platform Progress -->
        <div class="col-lg-8">
            <div class="glass-card p-4 mb-4">
                <h5 class="fw-bold mb-4">
                    <i class="fas fa-chart-bar me-2"></i>Platform Progress
                </h5>
                
                {% if platform_stats %}
                <div class="row g-3">
                    {% for stat in platform_stats %}
                    <div class="col-md-6">
                        <div class="platform-card p-3 
                            {% if stat.platform == 'leetcode' %}leetcode-bg{% endif %}
                            {% if stat.platform == 'geeksforgeeks' %}geeksforgeeks-bg{% endif %}
                            {% if stat.platform == 'hackerrank' %}hackerrank-bg{% endif %}
                            {% if stat.platform == 'github' %}github-bg{% endif %}
                        ">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0 text-white">{{ stat.platform.title() }}</h6>
                                <small class="text-white-50">{{ stat.streak }} day streak</small>
                            </div>
                            <div class="progress mb-2" style="height: 8px;">
                                {% set total = stat.easy_solved + stat.medium_solved + stat.hard_solved %}
                                {% set easy_pct = (stat.easy_solved / total * 100) if total > 0 else 0 %}
                                {% set medium_pct = (stat.medium_solved / total * 100) if total > 0 else 0 %}
                                {% set hard_pct = (stat.hard_solved / total * 100) if total > 0 else 0 %}
                                <div class="progress-bar bg-success" style="width: {{ easy_pct }}%"></div>
                                <div class="progress-bar bg-warning" style="width: {{ medium_pct }}%"></div>
                                <div class="progress-bar bg-danger" style="width: {{ hard_pct }}%"></div>
                            </div>
                            <div class="d-flex justify-content-between text-white-50">
                                {% if stat.platform == 'github' %}
                                <small>Repos: {{ stat.easy_solved }}</small>
                                <small>Stars: {{ stat.medium_solved }}</small>
                                <small>Followers: {{ stat.hard_solved }}</small>
                                {% else %}
                                <small>Easy: {{ stat.easy_solved }}</small>
                                <small>Medium: {{ stat.medium_solved }}</small>
                                <small>Hard: {{ stat.hard_solved }}</small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                    <h6 class="text-muted">No platform data yet</h6>
                    <p class="text-muted mb-3">Connect your coding platforms to see progress</p>
                    <a href="{{ url_for('coding') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Add Platform
                    </a>
                </div>
                {% endif %}
            </div>


        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Recent Activity -->
            <div class="glass-card p-4 mb-4">
                <h5 class="fw-bold mb-3">
                    <i class="fas fa-history me-2"></i>Recent Activity
                </h5>
                
                {% if recent_problems %}
                <div class="activity-feed">
                    {% for problem in recent_problems[:5] %}
                    <div class="activity-item">
                        <div class="activity-icon">
                            <i class="fas fa-check-circle text-success"></i>
                        </div>
                        <div class="activity-content">
                            <p class="mb-1">
                                <strong>{{ problem.problem.title if problem.problem else 'Problem' }}</strong>
                            </p>
                            <small class="text-muted">
                                {{ problem.solved_at.strftime('%b %d, %Y') }} â€¢ 
                                {{ problem.problem.difficulty if problem.problem else 'Unknown' }}
                            </small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-tasks fa-2x text-muted mb-2"></i>
                    <p class="text-muted mb-0">No recent activity</p>
                </div>
                {% endif %}
            </div>


        </div>
    </div>

    <!-- Analytics Section -->
    <div class="row g-4 mt-4">
        <!-- Platform Distribution & Difficulty Analysis -->
        <div class="col-lg-8">
            <!-- Platform Distribution -->
            <div class="glass-card p-4 mb-4">
                <h5 class="fw-bold mb-4">
                    <i class="fas fa-chart-pie me-2"></i>Platform Distribution
                </h5>
                <div class="row">
                    <div class="col-md-6">
                        <div style="height: 200px;">
                            <canvas id="platformChart"></canvas>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="platform-breakdown">
                            {% for stat in platform_stats %}
                            <div class="platform-breakdown-item mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <div class="d-flex align-items-center">
                                        <div class="platform-color-dot 
                                            {% if stat.platform == 'leetcode' %}leetcode-bg{% endif %}
                                            {% if stat.platform == 'geeksforgeeks' %}geeksforgeeks-bg{% endif %}
                                            {% if stat.platform == 'hackerrank' %}hackerrank-bg{% endif %}
                                            {% if stat.platform == 'github' %}github-bg{% endif %}
                                            me-2"></div>
                                        <span class="fw-bold">{{ stat.platform.title() }}</span>
                                    </div>
                                    <span class="text-muted">{{ stat.total_problems }} problems</span>
                                </div>
                                <div class="progress" style="height: 8px;">
                                    {% set total = stat.easy_solved + stat.medium_solved + stat.hard_solved %}
                                    {% set easy_pct = (stat.easy_solved / total * 100) if total > 0 else 0 %}
                                    {% set medium_pct = (stat.medium_solved / total * 100) if total > 0 else 0 %}
                                    {% set hard_pct = (stat.hard_solved / total * 100) if total > 0 else 0 %}
                                    <div class="progress-bar bg-success" style="width: {{ easy_pct }}%" title="Easy: {{ stat.easy_solved }}"></div>
                                    <div class="progress-bar bg-warning" style="width: {{ medium_pct }}%" title="Medium: {{ stat.medium_solved }}"></div>
                                    <div class="progress-bar bg-danger" style="width: {{ hard_pct }}%" title="Hard: {{ stat.hard_solved }}"></div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Difficulty Breakdown -->
            <div class="glass-card p-4">
                <h5 class="fw-bold mb-4">
                    <i class="fas fa-chart-bar me-2"></i>Difficulty Analysis
                </h5>
                <div style="height: 200px;">
                    <canvas id="difficultyChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Sidebar Analytics -->
        <div class="col-lg-4">
            <!-- Recent Achievements -->
            <div class="glass-card p-4 mb-4">
                <h5 class="fw-bold mb-3">
                    <i class="fas fa-medal me-2"></i>Recent Achievements
                </h5>
                
                <div class="achievement-list">
                    <div class="achievement-item mb-3">
                        <div class="d-flex align-items-center">
                            <div class="achievement-icon me-3">
                                <i class="fas fa-fire text-danger"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">Streak Master</h6>
                                <small class="text-muted">{{ platform_stats|map(attribute='streak')|max or 0 }} day coding streak</small>
                            </div>
                        </div>
                    </div>
                    <div class="achievement-item mb-3">
                        <div class="d-flex align-items-center">
                            <div class="achievement-icon me-3">
                                <i class="fas fa-code text-primary"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">Problem Solver</h6>
                                <small class="text-muted">{{ total_problems }}+ problems solved</small>
                            </div>
                        </div>
                    </div>
                    <div class="achievement-item mb-3">
                        <div class="d-flex align-items-center">
                            <div class="achievement-icon me-3">
                                <i class="fas fa-users text-success"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">Team Player</h6>
                                <small class="text-muted">Joined {{ user.study_group_memberships|length }} study groups</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Goal Progress -->
            <div class="glass-card p-4">
                <h5 class="fw-bold mb-3">
                    <i class="fas fa-bullseye me-2"></i>Goal Progress
                </h5>
                
                <div class="goal-item mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold">Monthly Target</span>
                        <span class="text-muted">{{ total_problems }}/50</span>
                    </div>
                    <div class="progress mb-1">
                        <div class="progress-bar bg-primary" style="width: {{ (total_problems / 50 * 100)|round|int if total_problems < 50 else 100 }}%"></div>
                    </div>
                    <small class="text-muted">{{ 50 - total_problems if total_problems < 50 else 0 }} problems remaining</small>
                </div>
                
                <div class="goal-item mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span class="fw-bold">Study Hours</span>
                        <span class="text-muted">{{ total_study_time // 60 }}h/20h</span>
                    </div>
                    <div class="progress mb-1">
                        <div class="progress-bar bg-success" style="width: {{ (total_study_time / 1200 * 100)|round|int if total_study_time < 1200 else 100 }}%"></div>
                    </div>
                    <small class="text-muted">{{ ((1200 - total_study_time) // 60)|round|int if total_study_time < 1200 else 0 }}h remaining</small>
                </div>
                
                {% if user.target_companies %}
                <div class="goal-item">
                    <div class="mb-2">
                        <span class="fw-bold">Target Companies</span>
                    </div>
                    <div class="target-companies">
                        {% for company in user.target_companies.split(',')[:3] %}
                        <span class="badge bg-info me-1">{{ company.strip() }}</span>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Detailed Study Sessions -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="glass-card p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h5 class="fw-bold mb-0">
                        <i class="fas fa-table me-2"></i>Recent Study Sessions
                    </h5>
                    <div class="btn-group btn-group-sm" role="group">
                        <button type="button" class="btn btn-outline-primary active" onclick="filterTable('all')">All</button>
                        <button type="button" class="btn btn-outline-primary" onclick="filterTable('coding')">Coding</button>
                        <button type="button" class="btn btn-outline-primary" onclick="filterTable('revision')">Revision</button>
                        <button type="button" class="btn btn-outline-primary" onclick="filterTable('study')">Study</button>
                    </div>
                </div>
                
                {% if study_sessions %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Duration</th>
                                <th>Topics</th>
                                <th>Problems Solved</th>
                                <th>Efficiency</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for session in study_sessions[:10] %}
                            <tr class="session-row" data-type="{{ session.session_type }}">
                                <td>{{ session.started_at.strftime('%b %d, %Y') }}</td>
                                <td>
                                    <span class="badge 
                                        {% if session.session_type == 'coding' %}bg-primary{% endif %}
                                        {% if session.session_type == 'revision' %}bg-success{% endif %}
                                        {% if session.session_type == 'study' %}bg-info{% endif %}
                                    ">
                                        {{ session.session_type.title() }}
                                    </span>
                                </td>
                                <td>{{ session.duration or 0 }} minutes</td>
                                <td>{{ session.topics_covered or 'N/A' }}</td>
                                <td>{{ session.problems_solved or 0 }}</td>
                                <td>
                                    {% set efficiency = (session.problems_solved / (session.duration / 60))|round(1) if session.duration and session.problems_solved else 0 %}
                                    <span class="badge 
                                        {% if efficiency >= 2 %}bg-success{% elif efficiency >= 1 %}bg-warning{% else %}bg-secondary{% endif %}
                                    ">
                                        {{ efficiency }} prob/hr
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-clock fa-2x text-muted mb-2"></i>
                    <p class="text-muted mb-0">No study sessions recorded yet</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Start Session Modal -->
<div class="modal fade" id="startSessionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content glass-modal">
            <div class="modal-header">
                <h5 class="modal-title">Start Study Session</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('start_study_session') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="sessionType" class="form-label">Session Type</label>
                        <select class="form-select" name="type" id="sessionType" required>
                            <option value="coding">Coding Practice</option>
                            <option value="revision">Concept Revision</option>
                            <option value="study">Topic Study</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="topics" class="form-label">Topics to Cover</label>
                        <textarea class="form-control" name="topics" id="topics" rows="3" 
                                  placeholder="e.g., Dynamic Programming, Binary Trees"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-play me-2"></i>Start Session
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- End Session Modal -->
<div class="modal fade" id="endSessionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content glass-modal">
            <div class="modal-header">
                <h5 class="modal-title">End Study Session</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('end_study_session') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="duration" class="form-label">Duration (minutes)</label>
                        <input type="number" class="form-control" name="duration" id="duration" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label for="problemsSolved" class="form-label">Problems Solved</label>
                        <input type="number" class="form-control" name="problems_solved" id="problemsSolved" min="0" value="0">
                    </div>
                    <div class="mb-3">
                        <label for="sessionNotes" class="form-label">Session Notes</label>
                        <textarea class="form-control" name="notes" id="sessionNotes" rows="3" 
                                  placeholder="What did you learn or accomplish?"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-stop me-2"></i>End Session
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Platform Chart
document.addEventListener('DOMContentLoaded', function() {
    // Platform Distribution Chart
    const platformCtx = document.getElementById('platformChart');
    if (platformCtx) {
        const platformData = {
            labels: [{% for stat in platform_stats %}'{{ stat.platform.title() }}'{% if not loop.last %}, {% endif %}{% endfor %}],
            datasets: [{
                data: [{% for stat in platform_stats %}{{ stat.total_problems }}{% if not loop.last %}, {% endif %}{% endfor %}],
                backgroundColor: [
                    'rgba(255, 165, 0, 0.8)',    // LeetCode - Orange
                    'rgba(34, 139, 34, 0.8)',    // GeeksforGeeks - Green
                    'rgba(0, 123, 255, 0.8)',    // HackerRank - Blue
                    'rgba(33, 37, 41, 0.8)'      // GitHub - Dark
                ],
                borderWidth: 2,
                borderColor: 'rgba(255, 255, 255, 0.1)'
            }]
        };

        new Chart(platformCtx, {
            type: 'doughnut',
            data: platformData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            color: 'rgba(255, 255, 255, 0.8)',
                            usePointStyle: true,
                            padding: 20
                        }
                    }
                }
            }
        });
    }

    // Difficulty Analysis Chart
    const difficultyCtx = document.getElementById('difficultyChart');
    if (difficultyCtx) {
        let totalEasy = 0, totalMedium = 0, totalHard = 0;
        {% for stat in platform_stats %}
        totalEasy += {{ stat.easy_solved }};
        totalMedium += {{ stat.medium_solved }};
        totalHard += {{ stat.hard_solved }};
        {% endfor %}

        const difficultyData = {
            labels: ['Easy', 'Medium', 'Hard'],
            datasets: [{
                label: 'Problems Solved',
                data: [totalEasy, totalMedium, totalHard],
                backgroundColor: [
                    'rgba(34, 197, 94, 0.8)',   // Green for Easy
                    'rgba(251, 191, 36, 0.8)',  // Yellow for Medium
                    'rgba(239, 68, 68, 0.8)'    // Red for Hard
                ],
                borderColor: [
                    'rgba(34, 197, 94, 1)',
                    'rgba(251, 191, 36, 1)',
                    'rgba(239, 68, 68, 1)'
                ],
                borderWidth: 2
            }]
        };

        new Chart(difficultyCtx, {
            type: 'bar',
            data: difficultyData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.8)'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    },
                    x: {
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.8)'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });
    }
});

// Filter table function
function filterTable(type) {
    // Update active button
    document.querySelectorAll('.btn-group button').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Filter rows
    document.querySelectorAll('.session-row').forEach(row => {
        if (type === 'all' || row.dataset.type === type) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
}

// Daily coding hours submission
document.getElementById('submitDailyHours').addEventListener('click', function() {
    const hours = document.getElementById('dailyCodingHours').value;
    
    if (!hours || hours < 0 || hours > 24) {
        alert('Please enter valid hours (0-24)');
        return;
    }
    
    fetch('/submit_daily_hours', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            hours: parseFloat(hours)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Daily hours saved successfully!');
            document.getElementById('dailyCodingHours').value = '';
        } else {
            alert('Error saving hours: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
});
</script>
{% endblock %}

{% extends "base.html" %}

{% block title %}Study Groups & Forum - CodeTrack Pro{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="glass-card p-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2 class="fw-bold gradient-text mb-2">
                            <i class="fas fa-users me-2"></i>Study Groups
                        </h2>
                        <p class="text-muted mb-0">Collaborate and learn together with like-minded developers</p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                            <i class="fas fa-plus me-2"></i>Create Group
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="row mb-4">
        <div class="col-12">
            <ul class="nav nav-pills justify-content-center" id="groupTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="my-groups-tab" data-bs-toggle="pill" data-bs-target="#my-groups">
                        <i class="fas fa-user-friends me-2"></i>My Groups ({{ user_groups|length }})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="recommended-tab" data-bs-toggle="pill" data-bs-target="#recommended">
                        <i class="fas fa-star me-2"></i>Recommended ({{ recommended_groups|length }})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="all-groups-tab" data-bs-toggle="pill" data-bs-target="#all-groups">
                        <i class="fas fa-globe me-2"></i>All Groups ({{ all_groups|length }})
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="doubts-tab" data-bs-toggle="pill" data-bs-target="#doubts">
                        <i class="fas fa-question-circle me-2"></i>Doubts Forum
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content" id="groupTabsContent">
        <!-- My Groups -->
        <div class="tab-pane fade show active" id="my-groups" role="tabpanel">
            {% if user_groups %}
            <div class="row g-4">
                {% for group in user_groups %}
                <div class="col-lg-6">
                    <div class="glass-card p-4 study-group-card">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="flex-grow-1">
                                <h5 class="fw-bold mb-1">{{ group.name }}</h5>
                                <p class="text-muted mb-2">{{ group.description or 'No description provided' }}</p>
                            </div>
                            <span class="badge bg-success">Member</span>
                        </div>
                        
                        <div class="row g-3 mb-3">
                            <div class="col-6">
                                <div class="study-group-stat">
                                    <i class="fas fa-book text-primary me-2"></i>
                                    <span class="fw-bold">{{ group.topic }}</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="study-group-stat">
                                    <i class="fas fa-signal text-info me-2"></i>
                                    <span class="fw-bold">{{ group.skill_level }}</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="study-group-stat">
                                    <i class="fas fa-users text-success me-2"></i>
                                    <span class="fw-bold">
                                        {{ group.members|length }}/{{ group.max_members }} members
                                    </span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="study-group-stat">
                                    <i class="fas fa-calendar text-warning me-2"></i>
                                    <span class="fw-bold">{{ group.created_at.strftime('%b %Y') }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                Created by {{ group.creator.username }}
                            </small>
                            <a href="{{ url_for('group_chat', group_id=group.id) }}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-comments me-1"></i>Chat
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="glass-card p-5 text-center">
                <i class="fas fa-users fa-4x text-muted mb-3"></i>
                <h4 class="text-muted mb-3">You haven't joined any study groups yet</h4>
                <p class="text-muted mb-4">Join a study group to collaborate and learn with others</p>
                <button type="button" class="btn btn-primary" data-bs-toggle="pill" data-bs-target="#recommended">
                    <i class="fas fa-search me-2"></i>Browse Recommended Groups
                </button>
            </div>
            {% endif %}
        </div>

        <!-- Recommended Groups -->
        <div class="tab-pane fade" id="recommended" role="tabpanel">
            {% if recommended_groups %}
            <div class="row g-4">
                {% for group in recommended_groups %}
                <div class="col-lg-6">
                    <div class="glass-card p-4 study-group-card">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="flex-grow-1">
                                <h5 class="fw-bold mb-1">{{ group.name }}</h5>
                                <p class="text-muted mb-2">{{ group.description or 'No description provided' }}</p>
                            </div>
                            <span class="badge bg-warning">
                                <i class="fas fa-star me-1"></i>Recommended
                            </span>
                        </div>
                        
                        <div class="row g-3 mb-3">
                            <div class="col-6">
                                <div class="study-group-stat">
                                    <i class="fas fa-book text-primary me-2"></i>
                                    <span class="fw-bold">{{ group.topic }}</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="study-group-stat">
                                    <i class="fas fa-signal text-info me-2"></i>
                                    <span class="fw-bold">{{ group.skill_level }}</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="study-group-stat">
                                    <i class="fas fa-users text-success me-2"></i>
                                    <span class="fw-bold">
                                        {{ group.members|length }}/{{ group.max_members }} members
                                    </span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="study-group-stat">
                                    <i class="fas fa-calendar text-warning me-2"></i>
                                    <span class="fw-bold">{{ group.created_at.strftime('%b %Y') }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                Created by {{ group.creator.username }}
                            </small>
                            <a href="{{ url_for('join_study_group', group_id=group.id) }}" class="btn btn-success btn-sm">
                                <i class="fas fa-plus me-1"></i>Join Group
                            </a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="glass-card p-5 text-center">
                <i class="fas fa-star fa-4x text-muted mb-3"></i>
                <h4 class="text-muted mb-3">No recommendations available</h4>
                <p class="text-muted mb-4">Complete your profile to get personalized group recommendations</p>
                <a href="{{ url_for('profile') }}" class="btn btn-primary">
                    <i class="fas fa-user-cog me-2"></i>Update Profile
                </a>
            </div>
            {% endif %}
        </div>

        <!-- All Groups -->
        <div class="tab-pane fade" id="all-groups" role="tabpanel">
            <!-- Filters -->
            <div class="glass-card p-3 mb-4">
                <div class="row g-3 align-items-center">
                    <div class="col-md-3">
                        <select class="form-select" id="topicFilter">
                            <option value="">All Topics</option>
                            <option value="Data Structures">Data Structures</option>
                            <option value="Algorithms">Algorithms</option>
                            <option value="System Design">System Design</option>
                            <option value="Web Development">Web Development</option>
                            <option value="Interview Preparation">Interview Preparation</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="skillFilter">
                            <option value="">All Levels</option>
                            <option value="Beginner">Beginner</option>
                            <option value="Intermediate">Intermediate</option>
                            <option value="Advanced">Advanced</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="searchFilter" placeholder="Search groups...">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-primary w-100" onclick="applyFilters()">
                            <i class="fas fa-filter me-1"></i>Filter
                        </button>
                    </div>
                </div>
            </div>

            {% if all_groups %}
            <div class="row g-4" id="groupsContainer">
                {% for group in all_groups %}
                <div class="col-lg-6 group-item" 
                     data-topic="{{ group.topic }}" 
                     data-skill="{{ group.skill_level }}" 
                     data-name="{{ group.name.lower() }}">
                    <div class="glass-card p-4 study-group-card">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="flex-grow-1">
                                <h5 class="fw-bold mb-1">{{ group.name }}</h5>
                                <p class="text-muted mb-2">{{ group.description or 'No description provided' }}</p>
                            </div>
                            {% if group.members|length >= group.max_members %}
                            <span class="badge bg-danger">Full</span>
                            {% else %}
                            <span class="badge bg-primary">{{ group.members|length }} spots left</span>
                            {% endif %}
                        </div>
                        
                        <div class="row g-3 mb-3">
                            <div class="col-6">
                                <div class="study-group-stat">
                                    <i class="fas fa-book text-primary me-2"></i>
                                    <span class="fw-bold">{{ group.topic }}</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="study-group-stat">
                                    <i class="fas fa-signal text-info me-2"></i>
                                    <span class="fw-bold">{{ group.skill_level }}</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="study-group-stat">
                                    <i class="fas fa-users text-success me-2"></i>
                                    <span class="fw-bold">
                                        {{ group.members|length }}/{{ group.max_members }} members
                                    </span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="study-group-stat">
                                    <i class="fas fa-calendar text-warning me-2"></i>
                                    <span class="fw-bold">{{ group.created_at.strftime('%b %Y') }}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">
                                Created by {{ group.creator.username }}
                            </small>
                            {% if group.members|length < group.max_members %}
                            <a href="{{ url_for('join_study_group', group_id=group.id) }}" class="btn btn-success btn-sm">
                                <i class="fas fa-plus me-1"></i>Join Group
                            </a>
                            {% else %}
                            <button class="btn btn-secondary btn-sm" disabled>
                                <i class="fas fa-lock me-1"></i>Full
                            </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="glass-card p-5 text-center">
                <i class="fas fa-users-slash fa-4x text-muted mb-3"></i>
                <h4 class="text-muted mb-3">No study groups available</h4>
                <p class="text-muted mb-4">Be the first to create a study group!</p>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                    <i class="fas fa-plus me-2"></i>Create First Group
                </button>
            </div>
            {% endif %}
        </div>

        <!-- Doubts Forum Tab -->
        <div class="tab-pane fade" id="doubts" role="tabpanel">
            <div class="row mb-4">
                <div class="col-md-8">
                    <div class="glass-card p-3">
                        <div class="row g-3 align-items-center">
                            <div class="col-md-4">
                                <input type="text" class="form-control" id="searchDoubts" placeholder="Search questions...">
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="categoryFilter">
                                    <option value="">All Categories</option>
                                    <option value="Data Structures">Data Structures</option>
                                    <option value="Algorithms">Algorithms</option>
                                    <option value="System Design">System Design</option>
                                    <option value="Web Development">Web Development</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-select" id="statusFilter">
                                    <option value="">All Status</option>
                                    <option value="solved">Solved</option>
                                    <option value="unsolved">Unsolved</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <button type="button" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#askQuestionModal">
                                    <i class="fas fa-plus me-1"></i>Ask
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="glass-card p-3 text-center">
                        <div class="row g-3">
                            <div class="col-4">
                                <h6 class="fw-bold text-primary mb-1">24</h6>
                                <small class="text-muted">Questions</small>
                            </div>
                            <div class="col-4">
                                <h6 class="fw-bold text-success mb-1">18</h6>
                                <small class="text-muted">Solved</small>
                            </div>
                            <div class="col-4">
                                <h6 class="fw-bold text-info mb-1">6</h6>
                                <small class="text-muted">Open</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dynamic Questions from Database -->

            {% if forum_posts %}
            <div class="row g-4">
                {% for post in forum_posts %}
                <div class="col-12">
                    <div class="glass-card p-4">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div class="flex-grow-1">
                                <h6 class="fw-bold mb-2">{{ post.title }}</h6>
                                <div class="d-flex flex-wrap gap-2 mb-2">
                                    <span class="badge bg-primary">{{ post.category or 'General' }}</span>
                                    {% if post.is_solved %}
                                    <span class="badge bg-success">Solved</span>
                                    {% else %}
                                    <span class="badge bg-warning">Open</span>
                                    {% endif %}
                                    {% if post.is_anonymous %}
                                    <span class="badge bg-secondary">Anonymous</span>
                                    {% endif %}
                                </div>
                                <p class="text-muted mb-2">{{ post.content[:150] }}{% if post.content|length > 150 %}...{% endif %}</p>
                            </div>
                            <small class="text-muted">{{ post.created_at.strftime('%b %d') }}</small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex gap-3">
                                <button class="btn btn-sm btn-outline-success" onclick="votePost({{ post.id }}, 'upvote')">
                                    <i class="fas fa-thumbs-up me-1"></i>{{ post.votes or 0 }}
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="viewAnswers({{ post.id }})">
                                    <i class="fas fa-comments me-1"></i>{{ post.answers|length }} answers
                                </button>
                                <small class="text-muted"><i class="fas fa-eye me-1"></i>{{ post.views }} views</small>
                            </div>
                            <a href="{{ url_for('enhanced_doubt_detail', post_id=post.id) }}" class="btn btn-outline-primary btn-sm">View Discussion</a>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="glass-card p-5 text-center">
                <i class="fas fa-question-circle fa-4x text-muted mb-3"></i>
                <h4 class="text-muted mb-3">No questions yet</h4>
                <p class="text-muted mb-4">Be the first to ask a question in the community forum</p>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#askQuestionModal">
                    <i class="fas fa-plus me-2"></i>Ask First Question
                </button>
            </div>
            {% endif%}
        </div>
    </div>
</div>

<!-- Ask Question Modal -->
<div class="modal fade" id="askQuestionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content glass-modal">
            <div class="modal-header">
                <h5 class="modal-title">Ask a Question</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('create_doubt') }}">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="questionTitle" class="form-label">Question Title</label>
                            <input type="text" class="form-control" name="title" id="questionTitle" required>
                        </div>
                        <div class="col-12">
                            <label for="questionContent" class="form-label">Question Details</label>
                            <textarea class="form-control" name="content" id="questionContent" rows="6" required></textarea>
                        </div>
                        <div class="col-md-6">
                            <label for="questionCategory" class="form-label">Category</label>
                            <select class="form-select" name="category" id="questionCategory" required>
                                <option value="">Select a category</option>
                                <option value="Data Structures">Data Structures</option>
                                <option value="Algorithms">Algorithms</option>
                                <option value="System Design">System Design</option>
                                <option value="Database">Database</option>
                                <option value="Web Development">Web Development</option>
                                <option value="Mobile Development">Mobile Development</option>
                                <option value="Machine Learning">Machine Learning</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="questionTags" class="form-label">Tags (comma separated)</label>
                            <input type="text" class="form-control" name="tags" id="questionTags" placeholder="e.g. recursion, optimization">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-2"></i>Post Question
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Create Group Modal -->
<div class="modal fade" id="createGroupModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content glass-modal">
            <div class="modal-header">
                <h5 class="modal-title">Create Study Group</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('create_study_group') }}">
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label for="groupName" class="form-label">Group Name</label>
                            <input type="text" class="form-control" name="name" id="groupName" required>
                        </div>
                        <div class="col-12">
                            <label for="groupDescription" class="form-label">Description</label>
                            <textarea class="form-control" name="description" id="groupDescription" rows="3"></textarea>
                        </div>
                        <div class="col-md-6">
                            <label for="groupTopic" class="form-label">Topic</label>
                            <select class="form-select" name="topic" id="groupTopic" required>
                                <option value="">Select a topic</option>
                                <option value="Data Structures">Data Structures</option>
                                <option value="Algorithms">Algorithms</option>
                                <option value="System Design">System Design</option>
                                <option value="Database">Database</option>
                                <option value="Web Development">Web Development</option>
                                <option value="Mobile Development">Mobile Development</option>
                                <option value="Machine Learning">Machine Learning</option>
                                <option value="DevOps">DevOps</option>
                                <option value="Competitive Programming">Competitive Programming</option>
                                <option value="Interview Preparation">Interview Preparation</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="skillLevel" class="form-label">Skill Level</label>
                            <select class="form-select" name="skill_level" id="skillLevel" required>
                                <option value="">Select level</option>
                                <option value="Beginner">Beginner</option>
                                <option value="Intermediate">Intermediate</option>
                                <option value="Advanced">Advanced</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="maxMembers" class="form-label">Maximum Members</label>
                            <input type="number" class="form-control" name="max_members" id="maxMembers" 
                                   min="2" max="20" value="10" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Create Group
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function applyFilters() {
    const topicFilter = document.getElementById('topicFilter').value;
    const skillFilter = document.getElementById('skillFilter').value;
    const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
    
    const groupItems = document.querySelectorAll('.group-item');
    
    groupItems.forEach(item => {
        const topic = item.dataset.topic;
        const skill = item.dataset.skill;
        const name = item.dataset.name;
        
        let show = true;
        
        if (topicFilter && topic !== topicFilter) show = false;
        if (skillFilter && skill !== skillFilter) show = false;
        if (searchFilter && !name.includes(searchFilter)) show = false;
        
        item.style.display = show ? 'block' : 'none';
    });
}

// Live search
document.getElementById('searchFilter').addEventListener('input', applyFilters);

// Voting functionality for forum posts
function votePost(postId, voteType) {
    fetch(`{{ url_for('vote_post', post_id=0, vote_type='upvote') }}`.replace('0', postId).replace('upvote', voteType), {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the vote count in the button
            const voteBtn = document.querySelector(`button[onclick*="votePost(${postId}"]`);
            const icon = voteBtn.querySelector('i');
            voteBtn.innerHTML = `${icon.outerHTML}${data.new_vote_count}`;
            
            // Add visual feedback
            voteBtn.style.backgroundColor = 'var(--bs-success)';
            voteBtn.style.color = 'white';
            setTimeout(() => {
                voteBtn.style.backgroundColor = '';
                voteBtn.style.color = '';
            }, 1000);
        } else {
            alert('Error voting: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to vote');
    });
}

// View answers functionality
function viewAnswers(postId) {
    // Redirect to the detailed discussion page
    window.location.href = `/enhanced_doubt_detail/${postId}`;
}
</script>
{% endblock %}

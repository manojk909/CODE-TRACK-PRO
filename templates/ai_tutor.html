{% extends "base.html" %}

{% block title %}AI Tutor - CodeTrack Pro{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="glass-card p-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2 class="fw-bold gradient-text mb-2">
                            <i class="fas fa-robot me-2"></i>AI Learning Assistant
                        </h2>
                        <p class="text-muted mb-0">Text chatbot for questions and video generator for topics</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Text Chatbot -->
        <div class="col-lg-6">
            <div class="glass-card p-4">
                <h5 class="fw-bold mb-3">
                    <i class="fas fa-comments me-2 text-primary"></i>Text Chatbot
                </h5>
                <p class="text-muted mb-4">Ask any coding question and get detailed written explanations</p>
                
                <div id="textChatHistory" class="chat-history mb-3 border rounded p-3" style="max-height: 400px; overflow-y: auto; background-color: rgba(255,255,255,0.05);">
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-comments fa-2x mb-2"></i>
                        <p>Start a conversation! Ask any coding question.</p>
                    </div>
                </div>
                
                <div class="input-group">
                    <input type="text" class="form-control" id="textChatInput" 
                           placeholder="Ask: What is a linked list? How does binary search work?" onkeypress="handleTextChatEnter(event)">
                    <button class="btn btn-primary" onclick="sendTextMessage()" id="textSendBtn">
                        <span class="btn-text">
                            <i class="fas fa-paper-plane"></i>
                        </span>
                        <span class="btn-loading d-none">
                            <span class="spinner-border spinner-border-sm"></span>
                        </span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Video Generator -->
        <div class="col-lg-6">
            <div class="glass-card p-4">
                <h5 class="fw-bold mb-3">
                    <i class="fas fa-video me-2 text-success"></i>Video Generator
                </h5>
                <p class="text-muted mb-4">Generate educational videos for programming topics</p>
                
                <div id="videoGeneratorHistory" class="video-history mb-3 border rounded p-3" style="max-height: 400px; overflow-y: auto; background-color: rgba(255,255,255,0.05);">
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-video fa-2x mb-2"></i>
                        <p>Generate videos for any programming topic!</p>
                    </div>
                </div>
                
                <div class="input-group">
                    <input type="text" class="form-control" id="videoTopicInput" 
                           placeholder="Topic: React Hooks, Binary Trees, Python OOP..." onkeypress="handleVideoGeneratorEnter(event)">
                    <button class="btn btn-success" onclick="generateVideo()" id="videoGenerateBtn">
                        <span class="btn-text">
                            <i class="fas fa-video me-2"></i>Generate
                        </span>
                        <span class="btn-loading d-none">
                            <span class="spinner-border spinner-border-sm me-2"></span>Generating...
                        </span>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Text Chat Functions
function handleTextChatEnter(event) {
    if (event.key === 'Enter') {
        sendTextMessage();
    }
}

function sendTextMessage() {
    const input = document.getElementById('textChatInput');
    const message = input.value.trim();
    const history = document.getElementById('textChatHistory');
    const btn = document.getElementById('textSendBtn');
    const btnText = btn.querySelector('.btn-text');
    const btnLoading = btn.querySelector('.btn-loading');
    
    if (!message) {
        alert('Please enter a question');
        return;
    }
    
    // Clear placeholder if it exists
    if (history.querySelector('.text-center')) {
        history.innerHTML = '';
    }
    
    // Add user message
    addChatMessage('user', message, history);
    input.value = '';
    
    // Show loading state
    btnText.classList.add('d-none');
    btnLoading.classList.remove('d-none');
    btn.disabled = true;
    
    // Send to server
    fetch('{{ url_for("text_chat") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
            'message': message
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addChatMessage('ai', data.response, history);
        } else {
            addChatMessage('ai', 'Sorry, I encountered an error: ' + data.error, history);
        }
    })
    .catch(error => {
        addChatMessage('ai', 'Failed to get response. Please try again.', history);
    })
    .finally(() => {
        // Reset button state
        btnText.classList.remove('d-none');
        btnLoading.classList.add('d-none');
        btn.disabled = false;
    });
}

// Video Generator Functions
function handleVideoGeneratorEnter(event) {
    if (event.key === 'Enter') {
        generateVideo();
    }
}

function generateVideo() {
    const input = document.getElementById('videoTopicInput');
    const topic = input.value.trim();
    const history = document.getElementById('videoGeneratorHistory');
    const btn = document.getElementById('videoGenerateBtn');
    const btnText = btn.querySelector('.btn-text');
    const btnLoading = btn.querySelector('.btn-loading');
    
    if (!topic) {
        alert('Please enter a topic');
        return;
    }
    
    // Clear placeholder if it exists
    if (history.querySelector('.text-center')) {
        history.innerHTML = '';
    }
    
    // Add topic request
    addVideoMessage('request', topic, history);
    input.value = '';
    
    // Show loading state
    btnText.classList.add('d-none');
    btnLoading.classList.remove('d-none');
    btn.disabled = true;
    
    // Send to server
    fetch('{{ url_for("generate_video") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: new URLSearchParams({
            'topic': topic
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            addVideoMessage('generated', data.video_content || 'Video content generated successfully!', history);
        } else {
            addVideoMessage('error', 'Failed to generate video: ' + data.error, history);
        }
    })
    .catch(error => {
        addVideoMessage('error', 'Failed to generate video. Please try again.', history);
    })
    .finally(() => {
        // Reset button state
        btnText.classList.remove('d-none');
        btnLoading.classList.add('d-none');
        btn.disabled = false;
    });
}

// Helper Functions
function addChatMessage(type, content, container) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `chat-message mb-3 ${type === 'user' ? 'text-end' : ''}`;
    
    const badge = type === 'user' ? 
        '<span class="badge bg-primary me-2">You</span>' : 
        '<span class="badge bg-success me-2"><i class="fas fa-robot me-1"></i>AI</span>';
    
    messageDiv.innerHTML = `
        <div class="${type === 'user' ? 'text-end' : ''}">
            ${badge}
        </div>
        <div class="p-2 rounded ${type === 'user' ? 'bg-primary text-white ms-5' : 'bg-light text-dark me-5'}" style="display: inline-block; max-width: 80%;">
            ${content.replace(/\n/g, '<br>')}
        </div>
    `;
    
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
}

function addVideoMessage(type, content, container) {
    const messageDiv = document.createElement('div');
    messageDiv.className = 'video-message mb-3';
    
    let badge, bgClass;
    if (type === 'request') {
        badge = '<span class="badge bg-info me-2">Topic</span>';
        bgClass = 'bg-info text-white';
    } else if (type === 'generated') {
        badge = '<span class="badge bg-success me-2"><i class="fas fa-video me-1"></i>Generated</span>';
        bgClass = 'bg-success text-white';
    } else {
        badge = '<span class="badge bg-danger me-2">Error</span>';
        bgClass = 'bg-danger text-white';
    }
    
    messageDiv.innerHTML = `
        <div>
            ${badge}
        </div>
        <div class="p-2 rounded ${bgClass}" style="display: inline-block; max-width: 90%;">
            ${content.replace(/\n/g, '<br>')}
        </div>
    `;
    
    container.appendChild(messageDiv);
    container.scrollTop = container.scrollHeight;
}
</script>
{% endblock %}
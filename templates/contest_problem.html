{% extends "base.html" %}

{% block title %}{{ problem.title }} - {{ contest.title }}{% endblock %}

{% block content %}
<div class="container-fluid mt-3">
    <!-- Contest Header -->
    <div class="glass-card p-3 mb-3">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <a href="{{ url_for('contest_participate', contest_id=contest.id) }}" 
                   class="btn btn-outline-secondary btn-sm me-3">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <div>
                    <h5 class="mb-0">{{ problem.title }}</h5>
                    <small class="text-muted">{{ contest.title }}</small>
                </div>
            </div>
            <div class="text-end">
                <div class="contest-timer h5 mb-0" id="timer">
                    <span class="badge bg-warning text-dark fs-6">
                        <i class="fas fa-clock me-1"></i>
                        <span id="timeRemaining">Loading...</span>
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Problem Statement -->
        <div class="col-lg-6">
            <div class="glass-card p-4 mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold">Problem Statement</h5>
                    <span class="badge bg-info">{{ problem.points }} points</span>
                </div>
                
                <div class="problem-content">
                    <h6 class="fw-bold">Description:</h6>
                    <p style="white-space: pre-wrap;">{{ problem.description }}</p>

                    {% if problem.constraints %}
                    <h6 class="fw-bold mt-4">Constraints:</h6>
                    <p style="white-space: pre-wrap;">{{ problem.constraints }}</p>
                    {% endif %}

                    {% if problem.examples %}
                    <h6 class="fw-bold mt-4">Examples:</h6>
                    <pre class="bg-dark p-3 rounded"><code>{{ problem.examples }}</code></pre>
                    {% endif %}

                    <!-- Sample Test Cases -->
                    {% if sample_test_cases %}
                    <h6 class="fw-bold mt-4">Sample Test Cases:</h6>
                    {% for test_case in sample_test_cases %}
                    <div class="card bg-dark mb-3">
                        <div class="card-header">
                            <strong>Sample {{ loop.index }}</strong>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Input:</strong>
                                    <pre class="bg-secondary p-2 rounded small mt-1"><code>{{ test_case.input_data }}</code></pre>
                                </div>
                                <div class="col-md-6">
                                    <strong>Output:</strong>
                                    <pre class="bg-secondary p-2 rounded small mt-1"><code>{{ test_case.expected_output }}</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                    {% endif %}

                    <!-- Coding Instructions -->
                    <div class="alert alert-info mt-4">
                        <h6 class="alert-heading">
                            <i class="fas fa-code me-2"></i>How to Code
                        </h6>
                        <ul class="mb-0 small">
                            <li>Complete the <strong>solution()</strong> function in the code editor</li>
                            <li>Your function should return the correct answer (don't use print or input)</li>
                            <li>Click <strong>"Run Code"</strong> to test your function against sample test cases</li>
                            <li>Click <strong>"Submit Solution"</strong> when ready to test against all hidden test cases</li>
                            <li>Use custom input only if you want to test the old input/output way</li>
                        </ul>
                    </div>

                    <div class="mt-3">
                        <small class="text-muted">
                            <i class="fas fa-clock me-1"></i>Time Limit: {{ problem.time_limit }} second(s)
                            | <i class="fas fa-memory me-1"></i>Memory Limit: {{ problem.memory_limit }} MB
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Code Editor & Testing -->
        <div class="col-lg-6">
            <div class="glass-card p-4 mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold">Code Editor</h5>
                    <div>
                        <select class="form-select form-select-sm" id="language" style="width: auto;">
                            <option value="python">Python</option>
                            <option value="java">Java</option>
                            <option value="cpp">C++</option>
                            <option value="c">C</option>
                        </select>
                    </div>
                </div>

                <!-- Code Editor -->
                <div class="mb-3">
                    <textarea class="form-control code-editor" id="codeEditor" rows="20" 
                              placeholder="# Write your solution here...">{% if latest_submission %}{{ latest_submission.code }}{% else %}{% if problem.title == "Sum of Two Numbers" %}def solution(a, b):
    """
    Return the sum of two numbers.
    Args:
        a (int): First number
        b (int): Second number
    Returns:
        int: Sum of a and b
    """
    # Write your solution here
    return a + b{% elif problem.title == "Reverse a String" %}def solution(s):
    """
    Return the reversed string.
    Args:
        s (str): Input string
    Returns:
        str: Reversed string
    """
    # Write your solution here
    return s[::-1]{% elif problem.title == "Find Maximum" %}def solution(numbers):
    """
    Return the maximum number from the list.
    Args:
        numbers (list): List of integers
    Returns:
        int: Maximum number
    """
    # Write your solution here
    return max(numbers){% else %}def solution():
    """
    Write your solution here.
    Modify the function signature and return statement as needed.
    """
    # Write your solution here
    pass{% endif %}{% endif %}</textarea>
                </div>

                <!-- Custom Input Testing -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Custom Input (optional - leave empty to test against sample cases):</label>
                    <textarea class="form-control" id="customInput" rows="3" 
                              placeholder="Leave empty to test with sample test cases, or enter custom input here..."></textarea>
                    <small class="text-muted">Tip: Leave this empty and click "Run Code" to test against sample test cases automatically!</small>
                </div>

                <!-- Action Buttons -->
                <div class="d-flex gap-2 mb-3">
                    <button class="btn btn-outline-primary" onclick="runCode()">
                        <i class="fas fa-play me-1"></i>Run Code
                    </button>
                    <button class="btn btn-success" onclick="submitCode()">
                        <i class="fas fa-paper-plane me-1"></i>Submit Solution
                    </button>
                    <button class="btn btn-outline-secondary" onclick="clearEditor()">
                        <i class="fas fa-eraser me-1"></i>Clear
                    </button>
                </div>

                <!-- Output Console -->
                <div>
                    <label class="form-label fw-bold">Output:</label>
                    <div class="console-output bg-dark p-3 rounded" id="console" style="min-height: 150px; font-family: 'Courier New', monospace;">
                        <div class="text-muted">
                            <i class="fas fa-terminal me-2"></i>Console output will appear here...
                        </div>
                    </div>
                </div>

                <!-- Submission Status -->
                {% if latest_submission %}
                <div class="mt-3 alert 
                    {% if latest_submission.status == 'accepted' %}alert-success
                    {% elif latest_submission.status == 'partial' %}alert-warning
                    {% elif latest_submission.status == 'wrong_answer' %}alert-danger
                    {% else %}alert-info{% endif %}">
                    <h6 class="alert-heading">Latest Submission:</h6>
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            Status: <strong>{{ latest_submission.status|title }}</strong>
                            | Score: <strong>{{ latest_submission.score }}/{{ problem.points }}</strong>
                        </div>
                        <small class="text-muted">{{ latest_submission.submitted_at.strftime('%H:%M:%S') }}</small>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-sm">
        <div class="modal-content bg-dark">
            <div class="modal-body text-center p-4">
                <div class="spinner-border text-primary mb-3"></div>
                <h6 id="loadingText">Processing...</h6>
            </div>
        </div>
    </div>
</div>

<style>
.code-editor {
    font-family: 'Courier New', monospace;
    font-size: 14px;
    line-height: 1.4;
    background-color: #1e1e1e;
    color: #d4d4d4;
    border: 1px solid #444;
}

.console-output {
    font-size: 13px;
    line-height: 1.3;
    max-height: 300px;
    overflow-y: auto;
    white-space: pre-wrap;
}

.problem-content {
    line-height: 1.6;
}

.problem-content pre {
    white-space: pre-wrap;
    word-break: break-word;
}

.contest-timer {
    font-family: 'Courier New', monospace;
}
</style>

<script>
let remainingSeconds = {{ remaining_seconds }};

function updateTimer() {
    if (remainingSeconds <= 0) {
        document.getElementById('timeRemaining').innerHTML = 
            '<span class="text-danger">TIME UP!</span>';
        // Auto-submit and redirect
        alert('Contest has ended! Redirecting to results...');
        window.location.href = "{{ url_for('contests') }}";
        return;
    }

    const hours = Math.floor(remainingSeconds / 3600);
    const minutes = Math.floor((remainingSeconds % 3600) / 60);
    const seconds = remainingSeconds % 60;

    let timeText = '';
    if (hours > 0) {
        timeText = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    } else {
        timeText = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    }

    document.getElementById('timeRemaining').textContent = timeText;
    remainingSeconds--;
}

function runCode() {
    const code = document.getElementById('codeEditor').value;
    const customInput = document.getElementById('customInput').value;
    const language = document.getElementById('language').value;

    if (!code.trim()) {
        alert('Please write some code first!');
        return;
    }

    showLoading('Running your code...');
    
    fetch(`{{ url_for('run_code', contest_id=contest.id, problem_id=problem.id) }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `code=${encodeURIComponent(code)}&custom_input=${encodeURIComponent(customInput)}&language=${language}`
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        const console = document.getElementById('console');
        
        if (data.success) {
            if (data.test_type === 'custom') {
                // Custom input execution
                let output = '<div class="text-success"><i class="fas fa-play me-2"></i><strong>Custom Input Execution</strong></div>';
                
                if (data.output) {
                    output += `<div class="mt-2"><strong>Output:</strong>\n<pre class="bg-dark p-2 rounded">${data.output}</pre></div>`;
                }
                
                if (data.error) {
                    output += `<div class="mt-2 text-warning"><strong>Errors/Warnings:</strong>\n<pre class="bg-dark p-2 rounded">${data.error}</pre></div>`;
                }
                
                output += `<div class="mt-2 text-muted small">Execution time: ${data.execution_time.toFixed(3)}s</div>`;
                console.innerHTML = output;
                
            } else if (data.test_type === 'sample') {
                // Sample test case execution
                let output = `<div class="text-info"><i class="fas fa-vials me-2"></i><strong>Sample Test Results</strong></div>`;
                output += `<div class="mt-2"><strong>Passed:</strong> ${data.passed_tests}/${data.total_tests} test cases</div>`;
                
                if (data.all_passed) {
                    output += `<div class="text-success mt-2"><i class="fas fa-check-circle me-2"></i>All sample tests passed!</div>`;
                } else {
                    output += `<div class="text-warning mt-2"><i class="fas fa-exclamation-triangle me-2"></i>Some tests failed</div>`;
                }
                
                // Show individual test results
                output += '<div class="mt-3"><strong>Test Details:</strong></div>';
                data.test_results.forEach(test => {
                    const statusIcon = test.passed ? 'fas fa-check text-success' : 'fas fa-times text-danger';
                    const statusText = test.passed ? 'PASS' : 'FAIL';
                    
                    output += `
                        <div class="card bg-dark mt-2 border-secondary">
                            <div class="card-header d-flex justify-content-between">
                                <span>Test Case ${test.test_number}</span>
                                <span><i class="${statusIcon}"></i> ${statusText}</span>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-4">
                                        <strong>Input:</strong>
                                        <pre class="bg-secondary p-1 rounded small">${test.input}</pre>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Expected:</strong>
                                        <pre class="bg-secondary p-1 rounded small">${test.expected}</pre>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Your Output:</strong>
                                        <pre class="bg-secondary p-1 rounded small ${test.passed ? 'text-success' : 'text-danger'}">${test.actual || (test.error ? 'Error occurred' : 'No output')}</pre>
                                    </div>
                                </div>
                                ${test.error ? `<div class="mt-2 text-danger small">Error: ${test.error}</div>` : ''}
                            </div>
                        </div>
                    `;
                });
                
                console.innerHTML = output;
            }
        } else {
            console.innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-circle me-2"></i><strong>Error:</strong>\n<pre class="bg-dark p-2 rounded">${data.error}</pre></div>`;
        }
    })
    .catch(error => {
        hideLoading();
        document.getElementById('console').innerHTML = 
            `<div class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i><strong>Network Error:</strong>\n${error.message}</div>`;
    });
}

function submitCode() {
    const code = document.getElementById('codeEditor').value;
    const language = document.getElementById('language').value;

    if (!code.trim()) {
        alert('Please write some code before submitting!');
        return;
    }

    if (!confirm('Are you sure you want to submit this solution?')) {
        return;
    }

    showLoading('Submitting and testing your solution...');
    
    fetch(`{{ url_for('submit_solution', contest_id=contest.id, problem_id=problem.id) }}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `code=${encodeURIComponent(code)}&language=${language}`
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        const console = document.getElementById('console');
        
        if (data.success) {
            let statusClass = '';
            let icon = '';
            
            if (data.status === 'accepted') {
                statusClass = 'text-success';
                icon = 'fas fa-check-circle';
            } else if (data.status === 'partial') {
                statusClass = 'text-warning';
                icon = 'fas fa-exclamation-triangle';
            } else {
                statusClass = 'text-danger';
                icon = 'fas fa-times-circle';
            }
            
            let output = `<div class="${statusClass}"><i class="${icon} me-2"></i><strong>Submission Result: ${data.status.toUpperCase()}</strong></div>`;
            output += `<div class="mt-2"><strong>Score:</strong> ${data.score}/{{ problem.points }} points</div>`;
            output += `<div class="mt-2"><strong>Test Cases:</strong> ${data.message}</div>`;
            
            // Add detailed test case results if available
            if (data.test_results && data.test_results.length > 0) {
                output += '<div class="mt-3"><strong>Test Case Details:</strong></div>';
                data.test_results.forEach((test, index) => {
                    const testIcon = test.passed ? 'fas fa-check text-success' : 'fas fa-times text-danger';
                    const testStatus = test.passed ? 'PASS' : 'FAIL';
                    
                    output += `
                        <div class="card bg-dark mt-2 border-secondary">
                            <div class="card-header d-flex justify-content-between">
                                <span>Test Case ${index + 1}</span>
                                <span><i class="${testIcon}"></i> ${testStatus}</span>
                            </div>
                            ${test.error ? `<div class="card-body text-danger small">Error: ${test.error}</div>` : ''}
                        </div>
                    `;
                });
            }
            
            console.innerHTML = output;
            
            // Show success message and option to continue
            setTimeout(() => {
                if (data.status === 'accepted') {
                    if (confirm('Congratulations! Problem solved successfully!\\n\\nWould you like to go back to the contest dashboard?')) {
                        window.location.href = "{{ url_for('contest_participate', contest_id=contest.id) }}";
                    }
                } else {
                    alert(`Submission completed with status: ${data.status}\\nScore: ${data.score}/{{ problem.points }}\\n\\nKeep trying to improve your solution!`);
                }
            }, 1000);
            
        } else {
            console.innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-circle me-2"></i><strong>Submission Error:</strong>\n<pre class="bg-dark p-2 rounded">${data.error}</pre></div>`;
        }
    })
    .catch(error => {
        hideLoading();
        document.getElementById('console').innerHTML = 
            `<div class="text-danger"><i class="fas fa-exclamation-triangle me-2"></i><strong>Network Error:</strong>\n${error.message}</div>`;
    });
}

function clearEditor() {
    if (confirm('Are you sure you want to clear the editor?')) {
        document.getElementById('codeEditor').value = '';
        document.getElementById('customInput').value = '';
        document.getElementById('console').innerHTML = '<div class="text-muted"><i class="fas fa-terminal me-2"></i>Console output will appear here...</div>';
    }
}

function showLoading(message) {
    document.getElementById('loadingText').textContent = message;
    new bootstrap.Modal(document.getElementById('loadingModal')).show();
}

function hideLoading() {
    bootstrap.Modal.getInstance(document.getElementById('loadingModal'))?.hide();
}

// Initialize timer
document.addEventListener('DOMContentLoaded', function() {
    updateTimer();
    setInterval(updateTimer, 1000);
});

// Auto-save code periodically
setInterval(() => {
    const code = document.getElementById('codeEditor').value;
    if (code.trim()) {
        localStorage.setItem(`contest_{{ contest.id }}_problem_{{ problem.id }}_code`, code);
    }
}, 10000); // Save every 10 seconds

// Auto-save when navigating away from problem
window.addEventListener('beforeunload', function(e) {
    // Save code to localStorage before leaving
    const code = document.getElementById('codeEditor').value;
    if (code.trim()) {
        localStorage.setItem(`contest_{{ contest.id }}_problem_{{ problem.id }}_code`, code);
    }
    // Don't show any warning - let navigation proceed smoothly
});

// Load saved code on page load
document.addEventListener('DOMContentLoaded', function() {
    const savedCode = localStorage.getItem(`contest_{{ contest.id }}_problem_{{ problem.id }}_code`);
    if (savedCode && !document.getElementById('codeEditor').value.trim()) {
        document.getElementById('codeEditor').value = savedCode;
    }
});
</script>
{% endblock %}
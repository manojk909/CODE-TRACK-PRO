{% extends "base.html" %}

{% block title %}Doubts Forum - CodeLearn Pro{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="glass-card p-4">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h2 class="fw-bold gradient-text mb-2">
                            <i class="fas fa-question-circle me-2"></i>Doubts Forum
                        </h2>
                        <p class="text-muted mb-0">Ask questions, share knowledge, and help the community</p>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createDoubtModal">
                            <i class="fas fa-plus me-2"></i>Ask Question
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats and Filters -->
    <div class="row g-4 mb-4">
        <div class="col-md-8">
            <!-- Filters -->
            <div class="glass-card p-3">
                <div class="row g-3 align-items-center">
                    <div class="col-md-3">
                        <select class="form-select" id="categoryFilter">
                            <option value="">All Categories</option>
                            {% for category in categories %}
                            <option value="{{ category }}">{{ category }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select class="form-select" id="statusFilter">
                            <option value="">All Status</option>
                            <option value="solved">Solved</option>
                            <option value="unsolved">Unsolved</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control" id="searchInput" placeholder="Search questions...">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-outline-primary w-100" onclick="applyFilters()">
                            <i class="fas fa-filter me-1"></i>Filter
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <!-- Quick Stats -->
            <div class="glass-card p-3 text-center">
                <div class="row g-3">
                    <div class="col-4">
                        <h6 class="fw-bold text-primary mb-1">{{ posts|length }}</h6>
                        <small class="text-muted">Questions</small>
                    </div>
                    <div class="col-4">
                        <h6 class="fw-bold text-success mb-1">
                            {{ posts|selectattr('is_solved', 'equalto', true)|list|length }}
                        </h6>
                        <small class="text-muted">Solved</small>
                    </div>
                    <div class="col-4">
                        <h6 class="fw-bold text-info mb-1">{{ posts|length - posts|selectattr('is_solved', 'equalto', true)|list|length }}</h6>
                        <small class="text-muted">Open</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Questions List -->
    <div class="glass-card p-4">
        {% if posts %}
        <div class="questions-list">
            {% for post in posts %}
            <div class="question-item mb-4 pb-4 border-bottom" 
                 data-category="{{ post.category }}" 
                 data-status="{{ 'solved' if post.is_solved else 'unsolved' }}"
                 data-title="{{ post.title.lower() }}">
                <div class="row align-items-start">
                    <div class="col-md-1 text-center">
                        <div class="question-votes">
                            <div class="vote-count fw-bold text-primary">{{ post.votes }}</div>
                            <small class="text-muted">votes</small>
                        </div>
                        <div class="question-answers mt-2">
                            <div class="answer-count fw-bold 
                                {% if post.is_solved %}text-success{% else %}text-muted{% endif %}">
                                {{ post.answers|length }}
                            </div>
                            <small class="text-muted">answers</small>
                        </div>
                    </div>
                    <div class="col-md-11">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="flex-grow-1">
                                <h5 class="mb-1">
                                    <a href="{{ url_for('doubt_detail', post_id=post.id) }}" 
                                       class="text-decoration-none question-title">
                                        {{ post.title }}
                                    </a>
                                    {% if post.is_solved %}
                                    <i class="fas fa-check-circle text-success ms-2" title="Solved"></i>
                                    {% endif %}
                                </h5>
                                <p class="text-muted mb-2">
                                    {{ post.content[:200] }}{% if post.content|length > 200 %}...{% endif %}
                                </p>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="question-tags">
                                <span class="badge bg-primary me-2">{{ post.category }}</span>
                                {% if post.tags %}
                                    {% for tag in post.tags.split(',')[:3] %}
                                    <span class="badge bg-outline-secondary me-1">{{ tag.strip() }}</span>
                                    {% endfor %}
                                {% endif %}
                            </div>
                            <div class="question-meta text-end">
                                <small class="text-muted">
                                    {% if post.is_anonymous %}
                                    Asked by <strong>Anonymous</strong>
                                    {% else %}
                                    Asked by <strong>{{ post.author.username }}</strong>
                                    {% endif %}
                                    on {{ post.created_at.strftime('%b %d, %Y') }}
                                </small>
                                <br>
                                <small class="text-muted">
                                    <i class="fas fa-eye me-1"></i>{{ post.views }} views
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-question-circle fa-4x text-muted mb-3"></i>
            <h4 class="text-muted mb-3">No questions yet</h4>
            <p class="text-muted mb-4">Be the first to ask a question and help build our knowledge base</p>
            <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createDoubtModal">
                <i class="fas fa-plus me-2"></i>Ask First Question
            </button>
        </div>
        {% endif %}
    </div>
</div>

<!-- Create Question Modal -->
<div class="modal fade" id="createDoubtModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content glass-modal">
            <div class="modal-header">
                <h5 class="modal-title">Ask a Question</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('create_doubt') }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="questionTitle" class="form-label">Question Title</label>
                        <input type="text" class="form-control" name="title" id="questionTitle" 
                               placeholder="What's your programming question?" required>
                        <div class="form-text">Be specific and clear in your question title</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="questionContent" class="form-label">Question Details</label>
                        <textarea class="form-control" name="content" id="questionContent" rows="8" 
                                  placeholder="Describe your problem in detail. Include any code, error messages, or specific scenarios..." required></textarea>
                        <div class="form-text">Provide as much context as possible to get better answers</div>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="questionCategory" class="form-label">Category</label>
                            <select class="form-select" name="category" id="questionCategory" required>
                                <option value="">Select a category</option>
                                {% for category in categories %}
                                <option value="{{ category }}">{{ category }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="questionTags" class="form-label">Tags</label>
                            <input type="text" class="form-control" name="tags" id="questionTags" 
                                   placeholder="python, algorithms, arrays">
                            <div class="form-text">Separate tags with commas</div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Post Question
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function applyFilters() {
    const categoryFilter = document.getElementById('categoryFilter').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    
    const questionItems = document.querySelectorAll('.question-item');
    
    questionItems.forEach(item => {
        const category = item.dataset.category.toLowerCase();
        const status = item.dataset.status;
        const title = item.dataset.title;
        
        let show = true;
        
        if (categoryFilter && !category.includes(categoryFilter)) show = false;
        if (statusFilter && status !== statusFilter) show = false;
        if (searchTerm && !title.includes(searchTerm)) show = false;
        
        item.style.display = show ? 'block' : 'none';
    });
}

// Live search
document.getElementById('searchInput').addEventListener('input', applyFilters);

// Auto-resize textarea
document.getElementById('questionContent').addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = this.scrollHeight + 'px';
});
</script>
{% endblock %}
